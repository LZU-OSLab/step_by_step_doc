# 总体介绍

## RISC-V

硬件指令集架构千千万，我们选择64位 RISC-V，无他，只是因为这个项目开始时老师推荐使用罢了（笑

先来简单介绍一下 RISC-V，这是一个与 x86 有相当大的区别的开源 RISC 指令集，由加州伯克利和校外的几位大佬共同开发，项目始于2010年，因此是个非常年轻的指令集架构，没有很多的历史包袱，一切从简，并且根据已有的指令集架构的优点和不足做了很多的改进，因此是一个非常“摩登”的指令集架构。它采用模块化设计，64位的基本指令集称为 RV64I，在此基础上可以扩展不同的指令集（如乘法、单双精度浮点的支持等），详细可见 [RISC-V 维基百科](https://zh.wikipedia.org/wiki/RISC-V#%E6%8C%87%E4%BB%A4%E5%AD%90%E9%9B%86)。

RISC-V 作为精简指令集，有大多数精简指令集架构都有的一大特性：通用寄存器非常多。在汇编代码层面与传统 x86 这类 CICS 的汇编语言也有很大的不同，比如没有入栈出栈的汇编语句，当然入栈和出栈的操作还是有的，但这就需要我们使用访存指令和栈指针的寄存器的加减来实现此类操作。具体指令当我们需要用到时会再介绍。

RISC-V 处理器通常有 3 个特权级，由高到底分别为 M 模式（machine mode）、S 模式（supervisor mode）和 U 模式（user mode）。M 模式下运行最受信任的代码，S 模式下运行操作系统，U 模式下运行用户程序。M 模式下的代码对整个系统拥有绝对控制权，可以控制一切硬件资源。

此外，RISC-V 标准还规定了一套 Supervisor 二进制接口（SBI），它运行于 M 模式，掌控着整台计算机，你可以认为它是 RISC-V 上的 BIOS，它提供了一些环境调用的支持。

## GCC

没错，我们使用 GCC，我们使用 C 语言（虽然GCC已经能编译很多其他语言了），因为大学期间我们学得最早也用得比较熟练的操作系统编程语言就是 C 语言了，其余的系统级编程语言如 Rust 语言在大学课程里出现比较罕见，自学的学习曲线也比较陡峭，因此我们还是选择比较传统且“落后”的 C 语言。

这里我们使用的 GCC 不是一般的 GCC，而是可以在 x86 架构下编译出 RISC-V 代码的交叉编译器。

## GDB

既然用了 GCC，那就用配套的调试平台 GDB 吧，没有什么其他的原因。

## QEMU

QEMU 是一个很棒的模拟器，可以通过动态的二进制转换，模拟CPU，因此能够让我们在 x86 的电脑上模拟出 RISC-V 的运行环境，便于我们的开发测试，还可以和 GDB 联动调试，非常方便。我们的系统很小很简单，因此也完全不需要考虑性能之类的问题，只要能跑起来就可以了。

此外，QEMU 还内置了一套 OpenSBI（SBI的一个开源实现），在我们编译好的可以模拟 64 位 RISC-V 的 QEMU 5.1 中内置的是 OpenSBI v0.7，指令集支持到了 RV64ACDFIMSU。

RV64ACDFIMSU：

- 原子指令(A)
- 压缩指令(C)
- 双精度浮点运算(D)
- 单精度浮点运算(F)
- 整数运算(RV64I)
- 整数乘除法(M)
- 特权级
  - M 模式（machine mode）
  - S 模式（supervisor mode）
  - U 模式（user mode）

## 参考资料

理解 SBI：

- [riscv-sbi-doc](https://github.com/riscv/riscv-sbi-doc/blob/master/riscv-sbi.adoc): SBI 规范。后续我们会封装其中一部分 ecall 调用。

理解 RISC-V 指令集和汇编语言：

- [RISC-V Assembly Language](https://github.com/riscv/riscv-asm-manual/blob/master/riscv-asm.md)：RISC-V 官方的汇编语言教程。篇幅很短，都是例子，需要有 RISC-V 指令的基础。
- [RISC-V Reader（中译版）](http://crva.ict.ac.cn/documents/RISC-V-Reader-Chinese-v2p1.pdf)：完整的 RISC-V 教程，包括主要的指令集拓展和汇编语言。该书假设读者有计算机组成原理、体系结构的知识，了解至少一种指令集，有使用汇编语言编程的经验。
- 《计算机组成与设计-硬件/软件接口（原书第 5 版）》：RISC-V 的两位主要设计者撰写的教材。第二章介绍 RISC-V 指令，并使用 RISC-V 指令编程。该书假设读者没有任何关于计算机组成原理和汇编语言的知识。
